#!/bin/bash

# Support-docs AWS Deployment Script
# ÂÆüË°åÂâç„Å´ AWS CLI Ë™çË®ºÊÉÖÂ†±„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ

set -e  # „Ç®„É©„ÉºÊôÇ„Å´ÂÅúÊ≠¢

echo "üöÄ Support-docs AWS „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÈñãÂßã"

# Â§âÊï∞Ë®≠ÂÆö
PROJECT_NAME="support-docs"
AWS_REGION="ap-northeast-1"
INSTANCE_TYPE="t3.medium"
DB_INSTANCE_CLASS="db.t3.small"
KEY_PAIR_NAME="support-docs-key"

# Ëâ≤‰ªò„Åç„Ç¢„Ç¶„Éà„Éó„ÉÉ„ÉàÈñ¢Êï∞
print_status() {
    echo -e "\n\033[1;34m[INFO]\033[0m $1"
}

print_success() {
    echo -e "\033[1;32m[SUCCESS]\033[0m $1"
}

print_warning() {
    echo -e "\033[1;33m[WARNING]\033[0m $1"
}

print_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}

# AWS CLI Á¢∫Ë™ç
check_aws_cli() {
    if ! command -v aws &> /dev/null; then
        print_error "AWS CLI „Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
        print_status "AWS CLI „Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åã„ÇâÂÜçÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        exit 1
    fi
    
    if ! aws sts get-caller-identity &> /dev/null; then
        print_error "AWSË™çË®ºÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì" 
        print_status "aws configure „ÇíÂÆüË°å„Åó„Å¶„Åã„ÇâÂÜçÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        exit 1
    fi
    
    print_success "AWS CLI Ë™çË®ºOK"
}

# VPC„Éª„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó‰ΩúÊàê
create_security_groups() {
    print_status "„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê‰∏≠..."
    
    # „Éá„Éï„Ç©„É´„ÉàVPC IDÂèñÂæó
    VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" \
        --query 'Vpcs[0].VpcId' --output text --region $AWS_REGION)
    
    if [ "$VPC_ID" = "None" ]; then
        print_error "„Éá„Éï„Ç©„É´„ÉàVPC„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
        exit 1
    fi
    
    # EC2„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó‰ΩúÊàê
    EC2_SG_ID=$(aws ec2 create-security-group \
        --group-name "${PROJECT_NAME}-ec2-sg" \
        --description "Security group for ${PROJECT_NAME} EC2 instance" \
        --vpc-id $VPC_ID \
        --query 'GroupId' --output text --region $AWS_REGION 2>/dev/null || \
        aws ec2 describe-security-groups \
        --filters "Name=group-name,Values=${PROJECT_NAME}-ec2-sg" \
        --query 'SecurityGroups[0].GroupId' --output text --region $AWS_REGION)
    
    # EC2„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó„É´„Éº„É´ËøΩÂä†
    aws ec2 authorize-security-group-ingress \
        --group-id $EC2_SG_ID \
        --protocol tcp --port 22 --cidr 0.0.0.0/0 \
        --region $AWS_REGION 2>/dev/null || true
    
    aws ec2 authorize-security-group-ingress \
        --group-id $EC2_SG_ID \
        --protocol tcp --port 80 --cidr 0.0.0.0/0 \
        --region $AWS_REGION 2>/dev/null || true
    
    aws ec2 authorize-security-group-ingress \
        --group-id $EC2_SG_ID \
        --protocol tcp --port 443 --cidr 0.0.0.0/0 \
        --region $AWS_REGION 2>/dev/null || true
    
    # RDS„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó‰ΩúÊàê
    RDS_SG_ID=$(aws ec2 create-security-group \
        --group-name "${PROJECT_NAME}-rds-sg" \
        --description "Security group for ${PROJECT_NAME} RDS instance" \
        --vpc-id $VPC_ID \
        --query 'GroupId' --output text --region $AWS_REGION 2>/dev/null || \
        aws ec2 describe-security-groups \
        --filters "Name=group-name,Values=${PROJECT_NAME}-rds-sg" \
        --query 'SecurityGroups[0].GroupId' --output text --region $AWS_REGION)
    
    # RDS„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó„É´„Éº„É´ËøΩÂä† (EC2„Åã„Çâ„ÅÆ„Åø„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ)
    aws ec2 authorize-security-group-ingress \
        --group-id $RDS_SG_ID \
        --protocol tcp --port 5432 \
        --source-group $EC2_SG_ID \
        --region $AWS_REGION 2>/dev/null || true
    
    print_success "„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó‰ΩúÊàêÂÆå‰∫Ü: EC2=$EC2_SG_ID, RDS=$RDS_SG_ID"
}

# S3„Éê„Ç±„ÉÉ„Éà‰ΩúÊàê
create_s3_bucket() {
    print_status "S3„Éê„Ç±„ÉÉ„Éà„Çí‰ΩúÊàê‰∏≠..."
    
    BUCKET_NAME="${PROJECT_NAME}-files-$(date +%s)"
    
    aws s3 mb s3://$BUCKET_NAME --region $AWS_REGION
    
    # „Éê„Ç±„ÉÉ„Éà„Éù„É™„Ç∑„ÉºË®≠ÂÆö („Éó„É©„Ç§„Éô„Éº„Éà)
    aws s3api put-public-access-block \
        --bucket $BUCKET_NAME \
        --public-access-block-configuration \
        "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
    
    # „Éê„Éº„Ç∏„Éß„Éã„É≥„Ç∞ÊúâÂäπÂåñ
    aws s3api put-bucket-versioning \
        --bucket $BUCKET_NAME \
        --versioning-configuration Status=Enabled
    
    print_success "S3„Éê„Ç±„ÉÉ„Éà‰ΩúÊàêÂÆå‰∫Ü: $BUCKET_NAME"
}

# IAM„É≠„Éº„É´‰ΩúÊàê
create_iam_role() {
    print_status "IAM„É≠„Éº„É´„Çí‰ΩúÊàê‰∏≠..."
    
    # ‰ø°È†º„Éù„É™„Ç∑„Éº
    cat > trust-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF
    
    # S3„Ç¢„ÇØ„Çª„Çπ„Éù„É™„Ç∑„Éº
    cat > s3-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::${BUCKET_NAME}/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::${BUCKET_NAME}"
    }
  ]
}
EOF
    
    # IAM„É≠„Éº„É´‰ΩúÊàê
    aws iam create-role \
        --role-name "${PROJECT_NAME}-ec2-role" \
        --assume-role-policy-document file://trust-policy.json \
        --region $AWS_REGION 2>/dev/null || true
    
    # „Éù„É™„Ç∑„Éº„Ç¢„Çø„ÉÉ„ÉÅ
    aws iam put-role-policy \
        --role-name "${PROJECT_NAME}-ec2-role" \
        --policy-name "S3Access" \
        --policy-document file://s3-policy.json \
        --region $AWS_REGION
    
    # „Ç§„É≥„Çπ„Çø„É≥„Çπ„Éó„É≠„Éï„Ç°„Ç§„É´‰ΩúÊàê
    aws iam create-instance-profile \
        --instance-profile-name "${PROJECT_NAME}-ec2-profile" \
        --region $AWS_REGION 2>/dev/null || true
    
    aws iam add-role-to-instance-profile \
        --instance-profile-name "${PROJECT_NAME}-ec2-profile" \
        --role-name "${PROJECT_NAME}-ec2-role" \
        --region $AWS_REGION 2>/dev/null || true
    
    # „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    rm trust-policy.json s3-policy.json
    
    print_success "IAM„É≠„Éº„É´‰ΩúÊàêÂÆå‰∫Ü"
}

# RDS‰ΩúÊàê
create_rds() {
    print_status "RDS PostgreSQL„Çí‰ΩúÊàê‰∏≠..."
    
    DB_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
    
    aws rds create-db-instance \
        --db-instance-identifier "${PROJECT_NAME}-db" \
        --db-instance-class $DB_INSTANCE_CLASS \
        --engine postgres \
        --engine-version 15.4 \
        --master-username postgres \
        --master-user-password "$DB_PASSWORD" \
        --allocated-storage 20 \
        --storage-type gp2 \
        --vpc-security-group-ids $RDS_SG_ID \
        --db-name support_docs \
        --backup-retention-period 7 \
        --storage-encrypted \
        --region $AWS_REGION 2>/dev/null || print_warning "RDS„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô"
    
    print_success "RDS‰ΩúÊàêÈñãÂßã (ÂÆå‰∫Ü„Åæ„Åß10-15ÂàÜÁ®ãÂ∫¶„Åã„Åã„Çä„Åæ„Åô)"
    print_status "DB „Éë„Çπ„ÉØ„Éº„Éâ: $DB_PASSWORD"
    
    # „Éë„Çπ„ÉØ„Éº„Éâ„Çí„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
    echo "DB_PASSWORD=$DB_PASSWORD" > .env.deploy
}

# „Ç≠„Éº„Éö„Ç¢‰ΩúÊàê
create_key_pair() {
    print_status "EC2„Ç≠„Éº„Éö„Ç¢„Çí‰ΩúÊàê‰∏≠..."
    
    if [ ! -f "${KEY_PAIR_NAME}.pem" ]; then
        aws ec2 create-key-pair \
            --key-name $KEY_PAIR_NAME \
            --query 'KeyMaterial' --output text \
            --region $AWS_REGION > "${KEY_PAIR_NAME}.pem"
        
        chmod 400 "${KEY_PAIR_NAME}.pem"
        print_success "„Ç≠„Éº„Éö„Ç¢‰ΩúÊàêÂÆå‰∫Ü: ${KEY_PAIR_NAME}.pem"
    else
        print_warning "„Ç≠„Éº„Éö„Ç¢„Éï„Ç°„Ç§„É´„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô: ${KEY_PAIR_NAME}.pem"
    fi
}

# EC2„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
create_ec2() {
    print_status "EC2„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê‰∏≠..."
    
    # ÊúÄÊñ∞„ÅÆUbuntu AMI IDÂèñÂæó
    AMI_ID=$(aws ec2 describe-images \
        --owners 099720109477 \
        --filters \
        "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*" \
        "Name=state,Values=available" \
        --query 'Images|sort_by(@, &CreationDate)[-1]|ImageId' \
        --output text --region $AWS_REGION)
    
    # „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Çπ„ÇØ„É™„Éó„Éà‰ΩúÊàê
    cat > user-data.sh << 'EOF'
#!/bin/bash
apt update && apt upgrade -y

# Node.js 18„Ç§„É≥„Çπ„Éà„Éº„É´
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# PM2„Ç§„É≥„Çπ„Éà„Éº„É´
npm install -g pm2

# ÂøÖË¶Å„Éë„ÉÉ„Ç±„Éº„Ç∏„Ç§„É≥„Çπ„Éà„Éº„É´
apt-get install -y \
  libnss3-dev \
  libgconf-2-4 \
  libxss1 \
  libxtst6 \
  libxrandr2 \
  libasound2-dev \
  libpangocairo-1.0-0 \
  libatk1.0-0 \
  libcairo-gobject2 \
  libgtk-3-0 \
  libgdk-pixbuf2.0-0 \
  nginx \
  git \
  postgresql-client \
  unzip

# Chrome „Ç§„É≥„Çπ„Éà„Éº„É´
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google.list
apt-get update && apt-get install -y google-chrome-stable

# „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
mkdir -p /opt/support-docs
chown ubuntu:ubuntu /opt/support-docs

# ÂÆå‰∫ÜÈÄöÁü•
echo "EC2 setup completed" > /home/ubuntu/setup-complete.txt
EOF
    
    # EC2„Ç§„É≥„Çπ„Çø„É≥„ÇπËµ∑Âãï
    INSTANCE_ID=$(aws ec2 run-instances \
        --image-id $AMI_ID \
        --count 1 \
        --instance-type $INSTANCE_TYPE \
        --key-name $KEY_PAIR_NAME \
        --security-group-ids $EC2_SG_ID \
        --iam-instance-profile Name="${PROJECT_NAME}-ec2-profile" \
        --user-data file://user-data.sh \
        --tag-specifications \
        "ResourceType=instance,Tags=[{Key=Name,Value=${PROJECT_NAME}-server},{Key=Project,Value=${PROJECT_NAME}}]" \
        --query 'Instances[0].InstanceId' \
        --output text --region $AWS_REGION)
    
    rm user-data.sh
    
    print_success "EC2„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÂÆå‰∫Ü: $INSTANCE_ID"
    
    # „Ç§„É≥„Çπ„Çø„É≥„ÇπËµ∑ÂãïÂæÖÊ©ü
    print_status "„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆËµ∑Âãï„ÇíÂæÖÊ©ü‰∏≠..."
    aws ec2 wait instance-running --instance-ids $INSTANCE_ID --region $AWS_REGION
    
    # Elastic IPÂâ≤„ÇäÂΩì„Å¶
    print_status "Elastic IP„ÇíÂâ≤„ÇäÂΩì„Å¶‰∏≠..."
    ALLOCATION_ID=$(aws ec2 allocate-address \
        --domain vpc \
        --query 'AllocationId' \
        --output text --region $AWS_REGION)
    
    aws ec2 associate-address \
        --instance-id $INSTANCE_ID \
        --allocation-id $ALLOCATION_ID \
        --region $AWS_REGION
    
    PUBLIC_IP=$(aws ec2 describe-addresses \
        --allocation-ids $ALLOCATION_ID \
        --query 'Addresses[0].PublicIp' \
        --output text --region $AWS_REGION)
    
    print_success "Elastic IPÂâ≤„ÇäÂΩì„Å¶ÂÆå‰∫Ü: $PUBLIC_IP"
    
    echo "INSTANCE_ID=$INSTANCE_ID" >> .env.deploy
    echo "PUBLIC_IP=$PUBLIC_IP" >> .env.deploy
}

# Áí∞Â¢ÉÂ§âÊï∞„Éï„Ç°„Ç§„É´ÁîüÊàê
generate_env_file() {
    print_status "Êú¨Áï™Áî®Áí∞Â¢ÉÂ§âÊï∞„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê‰∏≠..."
    
    # RDS „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÂèñÂæó
    print_status "RDS„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂèñÂæó‰∏≠..."
    while true; do
        RDS_ENDPOINT=$(aws rds describe-db-instances \
            --db-instance-identifier "${PROJECT_NAME}-db" \
            --query 'DBInstances[0].Endpoint.Address' \
            --output text --region $AWS_REGION 2>/dev/null)
        
        if [ "$RDS_ENDPOINT" != "None" ] && [ "$RDS_ENDPOINT" != "" ]; then
            break
        fi
        
        print_status "RDSËµ∑Âãï‰∏≠... 30ÁßíÂæå„Å´ÂÜçÁ¢∫Ë™ç"
        sleep 30
    done
    
    # „Éá„Éó„É≠„Ç§Áî®Áí∞Â¢ÉÂ§âÊï∞„Éï„Ç°„Ç§„É´ÁîüÊàê
    cat > .env.production << EOF
NODE_ENV=production
PORT=5000
CLIENT_URL=https://your-domain.com

# „Éá„Éº„Çø„Éô„Éº„ÇπË®≠ÂÆö
DB_HOST=$RDS_ENDPOINT
DB_PORT=5432
DB_NAME=support_docs
DB_USER=postgres
DB_PASSWORD=$DB_PASSWORD

# AWSË®≠ÂÆö
AWS_REGION=$AWS_REGION
AWS_S3_BUCKET=$BUCKET_NAME

# APIË®≠ÂÆö (ÂÆüÈöõ„ÅÆ„Ç≠„Éº„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ)
OPENAI_API_KEY=your-openai-api-key-here
ANTHROPIC_API_KEY=your-anthropic-api-key-here

# „Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö (ÂÆüÈöõ„ÅÆÂÄ§„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ)
JWT_SECRET=$(openssl rand -base64 64)
CORS_ORIGIN=https://your-domain.com

# PuppeteerË®≠ÂÆö
PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome
EOF
    
    print_success "Áí∞Â¢ÉÂ§âÊï∞„Éï„Ç°„Ç§„É´ÁîüÊàêÂÆå‰∫Ü: .env.production"
    echo "RDS_ENDPOINT=$RDS_ENDPOINT" >> .env.deploy
}

# „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÊâãÈ†ÜË°®Á§∫
show_deployment_instructions() {
    print_success "üéâ AWS „Ç§„É≥„Éï„É©ÊßãÁØâÂÆå‰∫ÜÔºÅ"
    
    echo -e "\nüìã Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó:"
    echo "1. .env.production „Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶ÂÆüÈöõ„ÅÆAPI„Ç≠„Éº„ÇíË®≠ÂÆö"
    echo "2. ‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅßEC2„Å´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Çí„Éá„Éó„É≠„Ç§:"
    echo ""
    echo "   # SSHÊé•Á∂ö"
    echo "   ssh -i ${KEY_PAIR_NAME}.pem ubuntu@$PUBLIC_IP"
    echo ""
    echo "   # „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈÖçÁΩÆ"
    echo "   cd /opt/support-docs"
    echo "   git clone [„ÅÇ„Å™„Åü„ÅÆ„É™„Éù„Ç∏„Éà„É™URL] ."
    echo "   npm install --production"
    echo "   cp .env.production .env"
    echo "   nano .env  # API„Ç≠„Éº„ÇíÂÆüÈöõ„ÅÆÂÄ§„Å´Á∑®ÈõÜ"
    echo ""
    echo "   # „Çµ„Éº„Éì„ÇπËµ∑Âãï"
    echo "   pm2 start server/index.js --name support-docs"
    echo "   pm2 startup && pm2 save"
    echo ""
    echo "3. „Éâ„É°„Ç§„É≥Ë®≠ÂÆö„Å®SSLË®ºÊòéÊõ∏ÂèñÂæó"
    echo "4. NginxË®≠ÂÆö"
    echo ""
    echo "üìä „É™„ÇΩ„Éº„ÇπÊÉÖÂ†±:"
    echo "   EC2 IP: $PUBLIC_IP"
    echo "   RDS Endpoint: $RDS_ENDPOINT"
    echo "   S3 Bucket: $BUCKET_NAME"
    echo ""
    echo "üí∞ Êé®ÂÆöÊúàÈ°ç„Ç≥„Çπ„Éà: $75-90 USD"
    echo ""
    echo "üìù Ë©≥Á¥∞ÊâãÈ†Ü: deployment/aws-deploy-checklist.md „ÇíÂèÇÁÖß"
}

# „É°„Ç§„É≥ÂÆüË°å
main() {
    print_status "Support-docs AWS „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÈñãÂßã"
    
    check_aws_cli
    create_security_groups
    create_s3_bucket
    create_iam_role
    create_key_pair
    create_rds
    create_ec2
    generate_env_file
    show_deployment_instructions
    
    print_success "üöÄ „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÊ∫ñÂÇôÂÆå‰∫ÜÔºÅ"
}

# „Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å
main "$@"